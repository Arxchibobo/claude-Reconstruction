name: Weekly Documentation Validation

on:
  # æ¯å‘¨ä¸€æ—©ä¸Š 8:00 (UTC) è¿è¡Œ
  schedule:
    - cron: '0 8 * * 1'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # PR æäº¤æ—¶è¿è¡Œ
  pull_request:
    paths:
      - '**.md'
      - 'scripts/validate-*.sh'
      - 'scripts/detect-*.sh'

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºæ£€æµ‹è¿‡æ—¶æ–‡æ¡£

      - name: Set up environment
        run: |
          echo "VALIDATION_DATE=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
          chmod +x scripts/*.sh

      - name: Run Markdown format validation
        id: markdown-validation
        continue-on-error: true
        run: |
          echo "## Markdown æ ¼å¼éªŒè¯" >> $GITHUB_STEP_SUMMARY
          bash scripts/validate-markdown.sh . 2>&1 | tee markdown-validation.log
          if [ $? -eq 0 ]; then
            echo "âœ… Markdown æ ¼å¼éªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Markdown æ ¼å¼éªŒè¯æœ‰è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run link validation
        id: link-validation
        continue-on-error: true
        run: |
          echo "## é“¾æ¥æœ‰æ•ˆæ€§éªŒè¯" >> $GITHUB_STEP_SUMMARY
          bash scripts/validate-links.sh . 2>&1 | tee link-validation.log
          if [ $? -eq 0 ]; then
            echo "âœ… æ‰€æœ‰é“¾æ¥æœ‰æ•ˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å‘ç°å¤±æ•ˆé“¾æ¥" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run duplicate detection
        id: duplicate-detection
        continue-on-error: true
        run: |
          echo "## é‡å¤å†…å®¹æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          bash scripts/detect-duplicates.sh . 2>&1 | tee duplicate-detection.log
          if [ $? -eq 0 ]; then
            echo "âœ… æœªæ£€æµ‹åˆ°é‡å¤å†…å®¹" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ å‘ç°é‡å¤å†…å®¹" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check outdated documents
        id: outdated-check
        continue-on-error: true
        run: |
          echo "## è¿‡æ—¶æ–‡æ¡£æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "æ£€æµ‹è¶…è¿‡ 90 å¤©æœªæ›´æ–°çš„æ–‡æ¡£ï¼š" >> $GITHUB_STEP_SUMMARY

          # æŸ¥æ‰¾è¶…è¿‡ 90 å¤©æœªä¿®æ”¹çš„ Markdown æ–‡ä»¶
          OUTDATED=$(find . -name "*.md" -type f \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*" \
            ! -path "*/archive/*" \
            -mtime +90 \
            -exec stat -c '%n (last modified: %y)' {} \; 2>/dev/null || \
            find . -name "*.md" -type f \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*" \
            ! -path "*/archive/*" \
            -mtime +90 \
            -exec ls -l {} \;)

          if [ -n "$OUTDATED" ]; then
            echo "âš ï¸ å‘ç° $(echo "$OUTDATED" | wc -l) ä¸ªè¿‡æ—¶æ–‡æ¡£" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$OUTDATED" | head -20 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æ‰€æœ‰æ–‡æ¡£ä¿æŒæ›´æ–°" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate statistics
        run: |
          echo "## æ–‡æ¡£ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- Markdown æ–‡ä»¶: $(find . -name '*.md' ! -path '*/node_modules/*' ! -path '*/.git/*' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript æ–‡ä»¶: $(find . -name '*.js' ! -path '*/node_modules/*' ! -path '*/.git/*' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Shell è„šæœ¬: $(find . -name '*.sh' ! -path '*/node_modules/*' ! -path '*/.git/*' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- é¡¹ç›®æ€»å¤§å°: $(du -sh . | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY

      - name: Upload validation reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-reports-${{ env.VALIDATION_DATE }}
          path: |
            markdown-validation.log
            link-validation.log
            duplicate-detection.log
          retention-days: 30

      - name: Create issue for failures
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let body = '## ğŸ“‹ Weekly Documentation Validation Failed\n\n';
            body += `**Date:** ${new Date().toISOString()}\n\n`;

            // è¯»å–æ—¥å¿—æ–‡ä»¶
            if (fs.existsSync('markdown-validation.log')) {
              body += '### Markdown Validation\n```\n';
              body += fs.readFileSync('markdown-validation.log', 'utf8').slice(-1000);
              body += '\n```\n\n';
            }

            if (fs.existsSync('link-validation.log')) {
              body += '### Link Validation\n```\n';
              body += fs.readFileSync('link-validation.log', 'utf8').slice(-1000);
              body += '\n```\n\n';
            }

            body += '**Action:** Please review the validation reports and fix the issues.\n';
            body += `**Workflow:** [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“‹ Weekly Validation Failed - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['documentation', 'automation', 'validation-failed']
            });

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ğŸ“‹ Documentation Validation Results\n\n';

            // è¯»å–éªŒè¯ç»“æœ
            const markdownLog = fs.existsSync('markdown-validation.log')
              ? fs.readFileSync('markdown-validation.log', 'utf8')
              : '';
            const linkLog = fs.existsSync('link-validation.log')
              ? fs.readFileSync('link-validation.log', 'utf8')
              : '';

            // ç»Ÿè®¡ç»“æœ
            const markdownPassed = markdownLog.includes('âœ“ æ‰€æœ‰æ–‡ä»¶éªŒè¯é€šè¿‡') || markdownLog.includes('é€šè¿‡ï¼ˆæœ‰è­¦å‘Šï¼‰');
            const linkPassed = linkLog.includes('âœ… æ‰€æœ‰é“¾æ¥éªŒè¯é€šè¿‡');

            if (markdownPassed && linkPassed) {
              comment += 'âœ… **All validations passed!**\n\n';
            } else {
              comment += 'âš ï¸ **Some validations have issues:**\n\n';
              if (!markdownPassed) comment += '- âŒ Markdown format validation\n';
              if (!linkPassed) comment += '- âŒ Link validation\n';
              comment += '\nPlease check the workflow logs for details.\n';
            }

            comment += `\n[View full report](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  test-error-cases:
    name: Run Error Case Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'validation/error-tests/package-lock.json'

      - name: Install dependencies
        working-directory: validation/error-tests
        run: npm ci

      - name: Run tests
        working-directory: validation/error-tests
        run: npm test -- --ci --coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage
          path: validation/error-tests/coverage/
          retention-days: 30

      - name: Comment test results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ğŸ§ª Error Case Test Results\n\n';

            // å°è¯•è¯»å–æµ‹è¯•ç»“æœï¼ˆå¦‚æœå­˜åœ¨ JSON reporterï¼‰
            try {
              const coverageFile = 'validation/error-tests/coverage/coverage-summary.json';
              if (fs.existsSync(coverageFile)) {
                const coverage = JSON.parse(fs.readFileSync(coverageFile, 'utf8'));
                const total = coverage.total;

                comment += '### Coverage Summary\n';
                comment += `- **Lines:** ${total.lines.pct}%\n`;
                comment += `- **Statements:** ${total.statements.pct}%\n`;
                comment += `- **Functions:** ${total.functions.pct}%\n`;
                comment += `- **Branches:** ${total.branches.pct}%\n\n`;
              }
            } catch (e) {
              comment += '_Coverage report not available_\n\n';
            }

            comment += `[View detailed report](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
