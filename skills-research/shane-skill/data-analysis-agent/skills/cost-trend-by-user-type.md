# 成本趋势分析（按用户类型）(Cost Trend by User Type)

## 描述

生成按用户类型堆叠的每日成本趋势图，帮助监控不同用户群体的成本分布和变化趋势。重点关注免费用户成本占比，支持用户获取策略优化。

## 何时调用此 Skill

使用此 skill 当你需要：
- ✅ 了解**不同用户类型的成本分布**（付费 vs 免费）
- ✅ 监控**免费用户成本占比**（核心 KPI）
- ✅ 识别**临时邮箱用户**的成本消耗
- ✅ 优化用户获取策略，降低免费成本
- ✅ 分析已删除用户和访客的成本影响
- ✅ 发现成本异常增长的用户群体

**关键词**: 免费成本、用户类型、临时邮箱、成本占比、用户分类

## 核心指标

- **免费成本占比** = 免费总成本 / 总成本 × 100%
- **目标**: 免费成本占比趋势向下 📉

## 用户分类逻辑

### 6 种用户类型

| 类型 | 条件 | 颜色 |
|------|------|------|
| **付费用户** | `user_membership_type != 'FREE'` | 蓝色 (#3B82F6) |
| **免费-临时邮箱** | FREE + 邮箱域名在临时邮箱列表（56个域名） | 青色 (#06B6D4) |
| **免费-白名单邮箱** | FREE + 邮箱域名在白名单（153个域名） | 橙色 (#F97316) |
| **免费-其他邮箱** | FREE + 有邮箱 + 不在临时邮箱/白名单 | 绿色 (#10B981) |
| **免费-已删除** | FREE + `user.source='privy'` + `user_privy` 无记录 | 粉色 (#D946EF) |
| **免费-访客** | FREE + `user.source='visitor'` | 紫色 (#8B5CF6) |

### 临时邮箱域名（56个）

包括但不限于: `yopmail.com`, `mailinator.com`, `10minutemail.com`, `guerrillamail.com`, `temp-mail.org`, `throwaway.email` 等

### 白名单邮箱域名（153个）

包括但不限于: `gmail.com`, `outlook.com`, `yahoo.com`, `hotmail.com`, `icloud.com`, `qq.com`, `163.com` 等

完整列表见原文档。

## 使用方法

### 基本用法

```
显示最近 7 天的每日成本趋势，按用户类型分组
```

### 参数说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `start_date` | 开始日期 (YYYY-MM-DD) | 7天前 | 2025-12-01 |
| `end_date` | 结束日期 (YYYY-MM-DD) | 昨天 | 2025-12-31 |

### 高级用法示例

**示例 1: 分析最近一周成本分布**
```
显示最近 7 天的每日成本趋势，按用户类型堆叠显示
```

**示例 2: 分析本月成本变化**
```
分析 2025年12月 的成本趋势，重点关注免费用户成本占比变化
```

**示例 3: 对比不同时间段**
```
对比 11月 和 12月 的免费用户成本占比，是否有改善？
```

**示例 4: 识别异常成本增长**
```
查看最近30天成本趋势，找出哪天免费用户成本激增
```

**示例 5: 临时邮箱用户分析**
```
分析最近一个月临时邮箱用户的成本变化趋势
```

## 输出内容

### 1. 堆叠面积图（Area Chart）

- **标题**: 每日成本趋势（按用户类型堆叠）
- **X轴**: 日期
- **Y轴**: 成本（美元）
- **6条堆叠区域**（从上到下）:
  - 付费用户（蓝色）
  - 免费-临时邮箱（青色）
  - 免费-白名单邮箱（橙色）
  - 免费-其他邮箱（绿色）
  - 免费-已删除（粉色）
  - 免费-访客（紫色）

### 2. 汇总统计

```
分析时间范围: {start_date} 至 {end_date}

======================== 成本汇总 ========================
总成本: ${total_cost}
  - 付费用户: ${paid_cost} ({paid_pct}%)
  - 免费用户: ${free_cost} ({free_pct}%)

免费用户成本细分:
  - 临时邮箱: ${temp_email_cost} ({temp_pct}% of free)
  - 白名单邮箱: ${whitelist_cost} ({whitelist_pct}% of free)
  - 其他邮箱: ${other_cost} ({other_pct}% of free)
  - 已删除: ${deleted_cost} ({deleted_pct}% of free)
  - 访客: ${visitor_cost} ({visitor_pct}% of free)

======================== 核心 KPI ========================
免费成本占比: {free_cost_ratio}%
目标: 趋势向下 📉
```

### 3. 趋势分析

- 每日免费成本占比变化
- 峰值/谷值日期
- 异常成本增长提醒

## 技术说明

### 数据来源

- `my_shell_prod.art_task` - 任务表（成本数据）
- `my_shell_prod.user` - 用户表（`source` 字段）
- `my_shell_prod.user_privy` - 用户邮箱信息

### 成本计算

- 包含 `status IN ('done', 'cancel')` 的任务
- 成本单位: `actual_energy_cost` ÷ 100（美分转美元）

### 查询拆分（5个独立查询）

为了职责单一，方便调试：
1. 付费用户成本
2. 临时邮箱用户成本
3. 白名单邮箱用户成本
4. 其他邮箱用户成本
5. 已删除用户成本
6. 访客用户成本

### 性能优化

- 使用 CTE 预先计算邮箱域名
- 减少函数重复调用（`SUBSTRING_INDEX`）
- 提前过滤时间范围

## 使用建议

### 定期监控

- **每周运行一次**: 监控免费成本占比趋势
- **每月对比**: 月度免费成本占比是否下降

### 异常告警

如果发现以下情况需要关注：
- 免费成本占比 > 70%（过高）
- 临时邮箱用户成本激增
- 某天成本突增 > 平均值 2 倍

### 优化方向

根据分析结果可以：
1. **限制临时邮箱注册**: 如果临时邮箱成本占比高
2. **优化免费额度**: 如果整体免费成本占比过高
3. **付费转化策略**: 针对高使用免费用户引导付费
4. **清理策略**: 定期清理长期不活跃的免费用户

## 常见问题

**Q1: 为什么要分这么多免费用户类型？**

不同类型的免费用户价值不同：
- **白名单邮箱**: 真实用户，有付费潜力
- **临时邮箱**: 可能是薅羊毛用户，低价值
- **访客**: 未注册用户，转化率低
- **已删除**: 历史数据，用于分析留存

**Q2: 如何更新临时邮箱/白名单列表？**

在原文档的临时邮箱域名列表和白名单列表中添加或删除域名，所有查询会自动应用新列表。

**Q3: 成本计算为什么包含 cancel 状态？**

取消的任务虽然没完成，但已经产生了计算成本（已启动执行），所以需要计入。

## 实现文件

完整实现请参考: `cost-trend-chart.md`
