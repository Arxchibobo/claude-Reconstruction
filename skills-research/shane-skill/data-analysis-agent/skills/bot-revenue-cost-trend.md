# Bot收入成本趋势分析 (Bot Revenue & Cost Trend)

## 描述

分析特定 bot(s) 的归因收入与成本趋势对比，支持按天和按周两种粒度。同时展示任务数量趋势，帮助理解成本变化的驱动因素。适合深入分析单个或多个 bot 的时间序列表现。

## 何时调用此 Skill

使用此 skill 当你需要：
- ✅ 查看**特定 bot 的时间序列表现**（按天或按周）
- ✅ 对比某个 bot 的**收入和成本随时间的变化**
- ✅ 了解 bot 的**任务数量趋势**（成本驱动因素）
- ✅ 发现 bot 的成本突增或收入异常时间点
- ✅ 对比多个 bot 的表现差异
- ✅ 查看具体的收入明细订单（每笔归因收入）

**关键词**: 趋势、时间序列、按天、按周、收入成本对比、任务数量

## 核心指标

- **每日/每周归因收入**: 通过 Last-Touch 优化版归因到该 bot 的收入
- **每日/每周实际成本**: 该 bot 产生的总成本（包含 done 和 cancel 任务）
- **任务数量**: 该 bot 的任务执行数量（成本主要驱动因素）
- **平均单任务成本**: 识别定价变化

## 使用方法

### 基本用法

```
分析 undress-generator 从上线至今的每日收入成本趋势
```

### 参数说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `slug_ids` | Bot slug ID 列表（逗号分隔） | 无（必填） | `undress-generator` 或 `undress-generator,flux-dev` |
| `start_date` | 开始日期 (YYYY-MM-DD) | Bot 第一个任务日期 | 2025-11-26 |
| `end_date` | 结束日期 (YYYY-MM-DD) | 昨天 | 2025-12-31 |
| `granularity` | 时间粒度：`daily`（按天）或 `weekly`（按周） | `daily` | `weekly` |

### 高级用法示例

**示例 1: 按天分析单个 bot（默认从上线开始）**
```
分析 undress-generator 从上线至今的每日收入成本趋势
```

**示例 2: 按周分析单个 bot**
```
分析 undress-generator 从上线至今的每周收入成本趋势，按周汇总
```

**示例 3: 分析多个 bot（按天对比）**
```
分析 undress-generator 和 breast-expansion 的每日收入成本趋势，
从各自首次任务日期开始
```

**示例 4: 指定日期范围（按周）**
```
分析 ai-blowjob 在 2025-12-01 至 2025-12-31 的每周收入成本趋势
```

**示例 5: 查看收入明细**
```
分析 undress-generator 最近 7 天的每日收入成本趋势，
并列出收入明细订单
```

## 输出内容

为每个 bot 生成：

### 1. 收入与成本对比图（折线图）

- 蓝色线: 归因收入
- 红色线: 实际成本
- X轴: 日期或周
- Y轴: 金额（美元）

### 2. 任务数量趋势图（折线图）

- 绿色线: 任务数量
- X轴: 日期或周
- Y轴: 任务数量
- 💡 **关键洞察**: 成本变化主要由任务数量驱动

### 3. 汇总数据

- 总收入（归因订单数）
- 总成本（总任务数）
- 平均单任务成本
- 总毛利润、总毛利率

### 4. 关键发现

- 收入/成本峰值日期和原因分析
- 任务数量激增的时间点
- 毛利率变化趋势

### 5. 收入明细（可选，Step 1.5）

| 订单时间 | 用户ID | 金额 | 来源 | 归因类型 |
|----------|--------|------|------|----------|
| 2025-12-27 23:45 | user_abc | $13.99 | stripe | before |
| 2025-12-27 22:18 | user_def | $19.99 | stripe | before |

**归因类型说明**:
- `before`: 订单前最后一次使用该 bot（试用后购买）
- `after`: 订单后首次使用该 bot（购买后使用）

## 技术说明

### 归因模型

使用 **Last-Touch 优化版**归因模型：
- **订单窗口**: `start_date` 至 `end_date`
- **任务窗口**: `start_date - 7天` 至 `end_date + 7天`
- 向前7天: 捕获用户付费前的试用行为
- 向后7天: 捕获"先付费后使用"的用户

⚠️ **关键**: 在归因时**不要在 tasks CTE 中预先过滤 slug_id**，必须让所有 bot 参与归因竞争，避免高估收入。

### 成本计算

- 包含 `status IN ('done', 'cancel')` 的任务
- 成本单位: `actual_energy_cost` ÷ 100（美分转美元）

### 数据来源

- **收入**: `user_subscription_stripe_orders`, `user_subscription_paypal_orders`
- **成本**: `art_task.actual_energy_cost`

## 常见问题

**Q1: 为什么收入和成本日期不完全对齐？**
- 收入按订单下单日期分组
- 成本按任务创建日期分组
- 用户可能在某天使用 bot（产生成本），但订单在其他日期

**Q2: 成本为什么突然从 $0 跳升？**
- 可能是计费系统在某个日期启用
- `actual_energy_cost` 字段开始记录
- 查看任务数量图确认是否有任务量激增

**Q3: 如何验证归因结果的正确性？**
- 使用"归因覆盖率验证"查询（见原文档 Step 1 末尾）
- 正常归因覆盖率应在 70-80%
- 如果过低，需要检查数据质量或调整时间窗口

## 实现文件

完整实现请参考: `bot-revenue-cost-trend.md`
