# Bot毛利率分析 (Bot Margin Analysis)

## 描述

分析每个 bot 的盈利能力，计算各个 bot 的收入、成本和毛利率。识别高毛利率的盈利 bot 和负毛利率的亏损 bot，为产品优化和资源分配提供决策依据。

## 何时调用此 Skill

使用此 skill 当你需要：
- ✅ 了解**哪些 bot 盈利，哪些亏损**
- ✅ 计算每个 bot 的**收入、成本、毛利率**
- ✅ 优化 bot 产品组合，决定下线或推广策略
- ✅ 识别高毛利率 bot（值得推广）和负毛利率 bot（需要优化）
- ✅ 为资源分配提供数据支持

**关键词**: bot、毛利率、盈利、亏损、收入归因、成本分析

## 核心指标

- **Bot 毛利率** = (Bot 收入 - Bot 成本) / Bot 收入 × 100%
- **Bot 收入**: 通过 Last-Touch 优化版归因模型分配到各个 bot 的收入
- **Bot 成本**: 该 bot 产生的 `actual_energy_cost` 总和
- **归因覆盖率**: 期望 70-80%

## 使用方法

### 基本用法

```
分析 2025-12-01 至 2025-12-31 期间各个 bot 的毛利率表现
```

### 参数说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `start_date` | 开始日期 (YYYY-MM-DD) | 2025-12-13 | 2025-12-01 |
| `end_date` | 结束日期 (YYYY-MM-DD) | 今天 | 2025-12-31 |

### 高级用法示例

**示例 1: 分析最近一个月的 bot 毛利率**
```
分析最近30天各个 bot 的毛利率，找出盈利最好和亏损最严重的 bot
```

**示例 2: 找出高毛利率 bot**
```
找出毛利率超过 50% 的前 10 个 bot
```

**示例 3: 识别亏损 bot**
```
识别哪些 bot 是负毛利率的，需要优化或考虑下线
```

**示例 4: 对比不同时间段**
```
对比 11月 和 12月 的 bot 毛利率变化，看哪些 bot 表现变好了
```

## 输出内容

1. **Bot 毛利率排行表** (CSV格式)
   - Bot ID, Bot名称, Slug ID
   - 收入, 成本, 毛利润, 毛利率(%)
   - 订单数量

2. **汇总指标**
   - 总订单收入、已归因收入、未归因收入
   - 归因覆盖率、总成本
   - 整体毛利率（基于归因收入）

3. **分类统计**
   - Top 5 高毛利率 Bot (毛利率 > 50%)
   - Bottom 5 低毛利率 Bot (毛利率 < 20%)
   - 负毛利率 Bot（需要优化或下线）

4. **未归因订单分析**
   - 从未使用的订单数和金额
   - 窗口外使用的订单数和金额

## 技术说明

### 归因模型

使用 **Last-Touch 优化版**归因模型：
1. **订单前归因**: 订单下单前最后使用的 bot
2. **订单后归因**: 如果订单前无使用记录，归因给订单后第一次使用的 bot
3. **时间窗口**: 订单窗口 ±7天（捕获试用转付费和先付费后使用场景）

### 性能优化

- ✅ 使用 SQL 层归因，避免传输百万级任务数据
- ✅ 数据传输量减少 99.9%（从200MB降到50KB）
- ✅ 查询时间: 15-45秒（比应用层归因快 3-10 倍）

### 数据来源

- **收入**: `user_subscription_stripe_orders`, `user_subscription_paypal_orders`, `apple_used_transactions`
- **成本**: `art_task.actual_energy_cost` (包含 done 和 cancel 状态)

## 注意事项

⚠️ **Apple IAP 收入按原价计算，未计算折扣码优惠**

⚠️ **归因 vs 成本的任务状态差异**:
- 归因: 只用 `status='done'` (完成的任务才影响付费决策)
- 成本: 包含 `status IN ('done','cancel')` (取消的任务也产生成本)

⚠️ **未归因订单属正常现象** (20-30%)，主要原因：
- 用户付费但从未使用任何 bot (90-95%)
- 使用时间超过 ±7天窗口 (5-10%)

## 实现文件

完整实现请参考: `bot-margin-analysis.md`
