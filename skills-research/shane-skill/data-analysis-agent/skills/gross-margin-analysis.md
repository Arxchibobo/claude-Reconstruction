# 整体毛利率分析 (Gross Margin Analysis)

## 描述

分析业务的整体盈利能力，计算整体毛利率和各维度的毛利率分布。按日或按月展示收入和成本对比，监控业务健康度。

## 何时调用此 Skill

使用此 skill 当你需要：
- ✅ 了解**整体业务的盈利能力**
- ✅ 按日/按月查看**收入和成本对比**
- ✅ 监控**毛利率变化趋势**
- ✅ 分析**不同渠道**（Stripe/PayPal/Apple IAP）的收入构成
- ✅ 判断业务是否健康（毛利率是否为正）
- ✅ 对比不同时间段的毛利率表现

**关键词**: 整体、毛利率、收入构成、业务健康度、盈利能力

## 核心指标

- **毛利率** = (收入 - 成本) / 收入 × 100%
- **毛利润** = 收入 - 成本
- **目标**: 毛利率持续为正且趋势向上 📈

## 使用方法

### 基本用法

```
分析 2025年12月 的整体毛利率表现
```

### 参数说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `start_date` | 开始日期 (YYYY-MM-DD) | 2025-12-13 | 2025-12-01 |
| `end_date` | 结束日期 (YYYY-MM-DD) | 今天 | 2025-12-31 |

### 高级用法示例

**示例 1: 分析最近30天毛利率趋势**
```
最近30天毛利率趋势如何？是否在改善？
```

**示例 2: 分析收入渠道构成**
```
Stripe、PayPal、Apple IAP 各贡献多少收入？占比如何？
```

**示例 3: 按月对比毛利率**
```
对比 10月、11月、12月 的毛利率变化，找出趋势
```

**示例 4: 识别毛利率异常日期**
```
查看最近一个月哪些天出现了负毛利率？原因是什么？
```

**示例 5: 分析特定时间段**
```
分析圣诞节期间（12月20-26日）的收入和成本情况
```

## 输出内容

### 1. 汇总指标

```
分析时间范围: {start_date} 至 {end_date}

======================== 收入汇总 ========================
总收入: ${total_revenue}
  - Stripe: ${total_stripe} ({stripe_pct}%)
  - PayPal: ${total_paypal} ({paypal_pct}%)
  - Apple IAP: ${total_iap} ({iap_pct}%) [未计折扣]

======================== 成本与毛利 ========================
总成本: ${total_cost}
毛利润: ${gross_profit}
毛利率: {gross_margin}%

日均收入: ${avg_daily_revenue}
日均成本: ${avg_daily_cost}
日均毛利润: ${avg_daily_profit}
```

### 2. 按日数据表格（CSV格式）

| 日期 | Stripe收入 | PayPal收入 | IAP收入 | 总收入 | 总成本 | 毛利润 | 毛利率(%) |
|------|-----------|-----------|---------|--------|--------|--------|-----------|
| 2025-12-19 | 150.00 | 80.00 | 120.00 | 350.00 | 200.00 | 150.00 | 42.86 |
| 2025-12-20 | 200.00 | 100.00 | 150.00 | 450.00 | 250.00 | 200.00 | 44.44 |

### 3. 可视化图表

**方案A: 双轴折线图**
- 左轴: 收入和成本金额（美元）
- 右轴: 毛利率（百分比）
- 3条线: 总收入（蓝色）、总成本（红色）、毛利率（绿色）

**方案B: 堆叠面积图（收入构成）**
- 3层堆叠: Stripe（蓝色）、PayPal（绿色）、Apple IAP（橙色）
- 标注: "Apple IAP 为原价，未计算折扣码优惠"

### 4. 关键发现

- 最高/最低毛利率日期
- 负毛利率日期及原因
- 收入增长趋势
- 成本控制情况

## 技术说明

### 收入来源

#### 1. Stripe 订单
- 表: `user_subscription_stripe_orders`
- 条件: `status = 'ORDER_STATUS_SUCCESS'` AND `amount >= 0`
- 字段: `amount` (已是美元)

#### 2. PayPal 订单
- 表: `user_subscription_paypal_orders`
- 条件: `status = 'ORDER_STATUS_SUCCESS'`
- **特殊处理**:
  - `biz_type = 'ENERGY'` AND `paypal_price_id = '500'` → $6.99
  - `biz_type = 'ENERGY'` AND `paypal_price_id = '2000'` → $20.99
  - 其他类型使用 `amount` 字段

#### 3. Apple IAP 订单
- 表: `apple_used_transactions`
- 按 `product_id` 映射价格:
  - `PLAYER_MONTHLY` → $6.99
  - `PLAYER_YEARLY` → $58.99
  - `DEVELOPER_MONTHLY` → $59.99
  - `DEVELOPER_YEARLY` → $499.99
  - `33OFF_DEVELOPER_MONTHLY` → $39.99
  - `energy_500` → $6.99
  - `energy_2000` → $20.99

⚠️ **注意**: Apple IAP 按原价计算，**未计算折扣码优惠**，实际收入可能更低。

### 成本来源

- 表: `art_task`
- 条件: `status IN ('done', 'cancel')`
- 字段: `actual_energy_cost` ÷ 100（美分转美元）
- 包含已取消任务（已产生成本）

### 数据合并

按日期合并三个收入源和成本，计算：
- 总收入 = Stripe + PayPal + IAP
- 毛利润 = 总收入 - 总成本
- 毛利率 = (毛利润 / 总收入) × 100%

## 与其他分析的关系

- **本文档**: 整体业务毛利率分析（收入来源）
- **bot-margin-analysis.md**: Bot 级别毛利率分析（收入归因到各 bot）
- **cost-trend-chart.md**: 成本按用户类型分析

三者结合可以全面了解业务盈利情况：
1. 整体毛利率（本文档）→ 业务健康度
2. Bot 毛利率 → 产品组合优化
3. 用户成本分布 → 用户获取策略

## 常见问题

**Q1: 为什么会出现负毛利率？**

可能原因：
- 大量免费用户使用（成本 > 收入）
- 收入归因模型问题（部分收入未计入）
- 成本异常高（基础设施成本分摊）
- 该时间段订单少但使用量大

建议查看：
- **cost-trend-chart.md**: 免费用户成本占比
- **bot-margin-analysis.md**: 哪些 bot 亏损

**Q2: Apple IAP 收入是否准确？**

⚠️ **不完全准确**，因为：
1. 按原价计算，未考虑折扣码优惠
2. 实际收入可能更低
3. 建议作为**最大值估算**

**Q3: 如何优化毛利率？**

两个方向：
1. **增加收入**:
   - 提升付费转化率
   - 优化定价策略
   - 推广高毛利 bot

2. **降低成本**:
   - 限制免费额度
   - 优化 bot 算法效率
   - 识别和限制薅羊毛用户（临时邮箱）

**Q4: 时区问题如何处理？**

数据库使用 `Asia/Shanghai` 时区，确保查询时：
- 日期范围使用 `YYYY-MM-DD 00:00:00` 和 `23:59:59`
- 避免跨时区数据遗漏或重复

## 使用建议

### 定期监控

- **每日查看**: 了解昨日毛利率表现
- **每周汇总**: 周度毛利率趋势
- **每月对比**: 月度毛利率是否改善

### 告警阈值

建议设置告警：
- 日毛利率 < 0%（负毛利）
- 周平均毛利率 < 10%（低毛利）
- 连续3天毛利率下降 > 5%（趋势恶化）

### 优化决策

根据毛利率表现制定策略：
- **毛利率 > 50%**: 健康，可扩大投入
- **30% < 毛利率 < 50%**: 正常，持续优化
- **10% < 毛利率 < 30%**: 预警，需要改进
- **毛利率 < 10%**: 危险，立即调整策略

## 实现文件

完整实现请参考: `gross-margin-analysis.md`
