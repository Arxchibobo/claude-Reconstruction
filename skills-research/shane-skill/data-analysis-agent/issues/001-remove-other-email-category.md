---
issue: 001
title: 移除"免费-其他邮箱"分类 - 修正用户成本分类逻辑
status: open
created: 2026-01-12
priority: P1
---

# 移除"免费-其他邮箱"分类

## 目标

修正成本趋势分析中的用户分类逻辑，消除不应该存在的"免费-其他邮箱"分类。

## 背景

在最近14天的成本趋势分析中，发现存在"免费-其他邮箱"分类：
- **平均成本**: $8.95/天
- **占比**: < 1%
- **日期范围**: 2025-12-29 至 2026-01-11
- **首次出现**: 2025-12-30 ($4.28)

根据业务逻辑，所有正常的邮箱域名应该已经被白名单覆盖，不应该存在"其他邮箱"这个分类。

## 当前问题

### 定义问题

"免费-其他邮箱"当前定义为：
- ✅ 有邮箱地址 (email/google_email/apple_email)
- ❌ 不在临时邮箱列表（56个域名）
- ❌ 不在白名单邮箱列表（153个域名）
- ❌ 不是 Gmail 别名

### 潜在原因

1. **白名单不完整**：可能有合法邮箱域名未被收录
2. **邮箱域名拼写错误**：用户输入错误导致无法匹配
3. **新兴邮箱服务**：新的邮箱服务商未及时加入白名单
4. **企业邮箱**：公司自定义域名邮箱
5. **教育机构邮箱**：大学等教育机构邮箱 (@xxx.edu)

## 数据分析

### 成本数据

| 日期 | 其他邮箱成本 ($) |
|------|-----------------|
| 12-29 | 0 |
| 12-30 | 4.28 |
| 12-31 | 12.02 |
| 01-01 | 6.59 |
| 01-02 | 10.46 |
| 01-03 | 8.20 |
| 01-04 | 11.32 |
| 01-05 | 8.46 |
| 01-06 | 7.76 |
| 01-07 | 8.26 |
| 01-08 | 10.80 |
| 01-09 | 9.13 |
| 01-10 | 8.73 |
| 01-11 | 10.38 |

**总计**: 约 $116.39 (14天)

### 涉及文件

- `cost-trend-chart.md` - 成本趋势图分析模板
  - 查询2d: 其他邮箱用户成本 (line 235-295)
  - 白名单邮箱列表 (line 45-68)
  - 临时邮箱列表 (line 24-39)

## 解决方案

### 方案1: 调查并补充白名单（推荐）⭐

**步骤**:
1. 查询"其他邮箱"的实际邮箱域名
   ```sql
   SELECT
     SUBSTRING_INDEX(COALESCE(NULLIF(up.email, ''),
                              NULLIF(up.google_email, ''),
                              NULLIF(up.apple_email, '')), '@', -1) as domain,
     COUNT(DISTINCT at.user_id) as user_count,
     SUM(at.actual_energy_cost) / 100 as total_cost
   FROM my_shell_prod.art_task at
   LEFT JOIN my_shell_prod.user_privy up ON at.user_id = up.user_id
   WHERE at.user_membership_type = 'FREE'
     AND at.status IN ('done', 'cancel')
     AND DATE(at.created_date) >= '2025-12-29'
     AND DATE(at.created_date) <= '2026-01-11'
     AND COALESCE(...) IS NOT NULL
     AND [其他邮箱的过滤条件]
   GROUP BY domain
   ORDER BY total_cost DESC
   ```

2. 分析这些域名：
   - 是否为合法邮箱服务商？→ 加入白名单
   - 是否为临时邮箱？→ 加入临时邮箱列表
   - 是否为垃圾/滥用邮箱？→ 单独处理或加入临时邮箱列表

3. 更新白名单和临时邮箱列表

**优点**:
- 彻底解决问题
- 提高分类准确性
- 保持数据完整性

**缺点**:
- 需要手动调查和判断
- 可能需要持续维护

### 方案2: 合并到"免费-白名单邮箱"

将"其他邮箱"归类为"免费-白名单邮箱"，假设这些都是正常用户。

**优点**:
- 简单快速
- 减少分类复杂度

**缺点**:
- 可能包含垃圾邮箱
- 丢失细分信息

### 方案3: 合并到"免费-已删除"

假设这些是数据质量问题或边缘情况。

**优点**:
- 不影响主要分类
- 标记为待调查

**缺点**:
- 语义不准确
- 不解决根本问题

## 推荐方案

**采用方案1**：调查并补充白名单

理由：
1. 成本占比虽小（< 1%），但不应该存在
2. 完善白名单有助于提高分类准确性
3. 符合"互斥分类"的设计原则
4. 有助于识别潜在的滥用行为

## 实施步骤

### Phase 1: 数据调查 🔍

- [ ] 1.1 执行SQL查询，获取"其他邮箱"的域名列表
- [ ] 1.2 导出域名及其成本数据
- [ ] 1.3 分析每个域名的类型（合法邮箱/临时邮箱/企业邮箱/教育邮箱）

### Phase 2: 更新白名单 ✏️

- [ ] 2.1 将合法邮箱域名添加到白名单（cost-trend-chart.md line 45-68）
- [ ] 2.2 将临时邮箱域名添加到临时邮箱列表（cost-trend-chart.md line 24-39）
- [ ] 2.3 更新 Notion 白名单页面（https://www.notion.so/myshellai/2d43f81ff51e805cb05df7eef873f2f5）

### Phase 3: 验证修复 ✅

- [ ] 3.1 重新执行成本趋势分析（最近14天）
- [ ] 3.2 确认"免费-其他邮箱"成本降至 $0 或接近 $0
- [ ] 3.3 确认其他分类的成本数据正确

### Phase 4: 持续监控 📊

- [ ] 4.1 在每周/每月分析中监控"其他邮箱"成本
- [ ] 4.2 发现新的未分类域名时及时处理
- [ ] 4.3 建立白名单更新流程

## 涉及文件修改

1. `cost-trend-chart.md`
   - 白名单邮箱列表（line 45-68）
   - 临时邮箱列表（line 24-39）

2. 可能需要修改的 Cron Jobs:
   - `functions/api/cron/sync-cost-snapshot.ts` - 如果使用相同的分类逻辑
   - `functions/api/cron/daily-summary.ts` - 如果涉及成本分类汇总
   - `functions/api/cron/weekly-analysis.ts` - 如果涉及成本趋势分析

## 风险

| 风险 | 影响 | 缓解方案 |
|------|------|----------|
| 白名单过大导致查询变慢 | 性能下降 | 使用 IN 子句或者将白名单存储到数据库表 |
| 误将临时邮箱加入白名单 | 分类错误 | 仔细调查每个域名 |
| 持续有新的"其他邮箱" | 维护成本高 | 建立定期审查流程 |

## 成功标准

- [ ] "免费-其他邮箱"成本降至 $0 或 < $1/天
- [ ] 白名单和临时邮箱列表更新完成
- [ ] 所有免费用户都能被正确分类（互斥且完整）
- [ ] 文档更新完成

## 参考

- [cost-trend-chart.md](../cost-trend-chart.md) - 成本趋势图分析模板
- [Notion 白名单](https://www.notion.so/myshellai/2d43f81ff51e805cb05df7eef873f2f5) - 邮箱白名单维护页面
- [CLAUDE.md](../CLAUDE.md) - 项目架构文档

## 下一步

1. **立即执行**：运行 SQL 查询，获取"其他邮箱"的域名列表
2. **调查分析**：判断每个域名的类型和合法性
3. **更新白名单**：将合法域名加入白名单
4. **验证结果**：重新生成成本趋势图，确认问题解决
